{
  "name": "AI Agent with ComfyUI Image Generation",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "chat-trigger-1",
      "name": "Chat Trigger",
      "type": "n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [240, 300],
      "webhookId": "comfyui-agent"
    },
    {
      "parameters": {
        "chatMessageHistory": {
          "__rl": true,
          "mode": "auto",
          "value": "={{ $memory.memoryId }}"
        },
        "options": {
          "systemMessage": "You are a helpful AI assistant with image generation capabilities. When users ask to create images, use the ComfyUI tool to generate them. Be creative and helpful!"
        }
      },
      "id": "openai-agent-1",
      "name": "OpenAI Conversational Agent",
      "type": "n8n-nodes-langchain.agent.openAi",
      "typeVersion": 1.7,
      "position": [460, 300],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "language": "javaScript",
        "jsCode": "// ==================== ComfyUI Image Generator Tool ====================\n// 配置\nconst COMFYUI_URL = 'http://127.0.0.1:8188';\n\n// 工作流模板（根据你的 ComfyUI 设置修改）\nconst WORKFLOW_TEMPLATE = {\n  \"3\": {\n    \"inputs\": {\n      \"seed\": 0,\n      \"steps\": 20,\n      \"cfg\": 8,\n      \"sampler_name\": \"euler\",\n      \"scheduler\": \"normal\",\n      \"denoise\": 1,\n      \"model\": [\"4\", 0],\n      \"positive\": [\"6\", 0],\n      \"negative\": [\"7\", 0],\n      \"latent_image\": [\"5\", 0]\n    },\n    \"class_type\": \"KSampler\"\n  },\n  \"4\": {\n    \"inputs\": {\n      \"ckpt_name\": \"v1-5-pruned-emaonly.ckpt\"\n    },\n    \"class_type\": \"CheckpointLoaderSimple\"\n  },\n  \"5\": {\n    \"inputs\": {\n      \"width\": 512,\n      \"height\": 512,\n      \"batch_size\": 1\n    },\n    \"class_type\": \"EmptyLatentImage\"\n  },\n  \"6\": {\n    \"inputs\": {\n      \"text\": \"\",\n      \"clip\": [\"4\", 1]\n    },\n    \"class_type\": \"CLIPTextEncode\"\n  },\n  \"7\": {\n    \"inputs\": {\n      \"text\": \"ugly, blurry, low quality\",\n      \"clip\": [\"4\", 1]\n    },\n    \"class_type\": \"CLIPTextEncode\"\n  },\n  \"8\": {\n    \"inputs\": {\n      \"samples\": [\"3\", 0],\n      \"vae\": [\"4\", 2]\n    },\n    \"class_type\": \"VAEDecode\"\n  },\n  \"9\": {\n    \"inputs\": {\n      \"filename_prefix\": \"ComfyUI\",\n      \"images\": [\"8\", 0]\n    },\n    \"class_type\": \"SaveImage\"\n  }\n};\n\n// 解析输入参数\nfunction parseInput(query) {\n  const params = {\n    prompt: query.trim(),\n    negative_prompt: 'ugly, blurry, low quality, distorted',\n    width: 512,\n    height: 512,\n    steps: 20,\n    cfg: 8,\n    seed: Math.floor(Math.random() * 2147483647)\n  };\n\n  // 提取负向提示词\n  const negativeMatch = query.match(/negative:\\s*([^\\n]+)/i);\n  if (negativeMatch) {\n    params.negative_prompt = negativeMatch[1].trim();\n    params.prompt = params.prompt.replace(/negative:\\s*[^\\n]+/i, '').trim();\n  }\n\n  // 提取尺寸\n  const sizeMatch = query.match(/size:\\s*(\\d+)x(\\d+)/i);\n  if (sizeMatch) {\n    params.width = parseInt(sizeMatch[1]);\n    params.height = parseInt(sizeMatch[2]);\n    params.prompt = params.prompt.replace(/size:\\s*\\d+x\\d+/i, '').trim();\n  }\n\n  // 提取步数\n  const stepsMatch = query.match(/steps:\\s*(\\d+)/i);\n  if (stepsMatch) {\n    params.steps = parseInt(stepsMatch[1]);\n    params.prompt = params.prompt.replace(/steps:\\s*\\d+/i, '').trim();\n  }\n\n  // 提取 CFG\n  const cfgMatch = query.match(/cfg:\\s*([\\d.]+)/i);\n  if (cfgMatch) {\n    params.cfg = parseFloat(cfgMatch[1]);\n    params.prompt = params.prompt.replace(/cfg:\\s*[\\d.]+/i, '').trim();\n  }\n\n  // 提取种子\n  const seedMatch = query.match(/seed:\\s*(\\d+)/i);\n  if (seedMatch) {\n    params.seed = parseInt(seedMatch[1]);\n    params.prompt = params.prompt.replace(/seed:\\s*\\d+/i, '').trim();\n  }\n\n  return params;\n}\n\n// 更新工作流\nfunction updateWorkflow(workflow, params) {\n  const updatedWorkflow = JSON.parse(JSON.stringify(workflow));\n  updatedWorkflow[\"6\"].inputs.text = params.prompt;\n  updatedWorkflow[\"7\"].inputs.text = params.negative_prompt;\n  updatedWorkflow[\"5\"].inputs.width = params.width;\n  updatedWorkflow[\"5\"].inputs.height = params.height;\n  updatedWorkflow[\"3\"].inputs.steps = params.steps;\n  updatedWorkflow[\"3\"].inputs.cfg = params.cfg;\n  updatedWorkflow[\"3\"].inputs.seed = params.seed;\n  return updatedWorkflow;\n}\n\n// 执行工作流\nasync function executeComfyUIWorkflow(workflow) {\n  const axios = require('axios');\n\n  // 队列提示词\n  const promptResponse = await axios.post(`${COMFYUI_URL}/prompt`, {\n    prompt: workflow\n  });\n\n  const promptId = promptResponse.data.prompt_id;\n\n  // 轮询结果\n  let attempts = 0;\n  const maxAttempts = 120;\n\n  while (attempts < maxAttempts) {\n    await new Promise(resolve => setTimeout(resolve, 1000));\n\n    const historyResponse = await axios.get(`${COMFYUI_URL}/history/${promptId}`);\n\n    if (historyResponse.data[promptId]) {\n      const outputs = historyResponse.data[promptId].outputs;\n\n      if (outputs) {\n        const images = [];\n\n        for (const nodeId in outputs) {\n          if (outputs[nodeId].images && outputs[nodeId].images.length > 0) {\n            for (const image of outputs[nodeId].images) {\n              images.push({\n                filename: image.filename,\n                url: `${COMFYUI_URL}/view?filename=${image.filename}&subfolder=${image.subfolder}&type=${image.type}`\n              });\n            }\n          }\n        }\n\n        return { success: true, images: images };\n      }\n    }\n\n    attempts++;\n  }\n\n  throw new Error('Workflow execution timeout');\n}\n\n// 主处理函数\nfor (const item of items) {\n  const query = item.json.query || '';\n\n  try {\n    const params = parseInput(query);\n    const workflow = updateWorkflow(WORKFLOW_TEMPLATE, params);\n    const result = await executeComfyUIWorkflow(workflow);\n\n    return {\n      json: {\n        success: true,\n        message: `Generated ${result.images.length} image(s): \"${params.prompt}\"`,\n        images: result.images.map(img => img.url),\n        parameters: params\n      }\n    };\n\n  } catch (error) {\n    return {\n      json: {\n        success: false,\n        error: error.message\n      }\n    };\n  }\n}"
      },
      "id": "comfyui-tool-1",
      "name": "ComfyUI Image Generator",
      "type": "n8n-nodes-langchain.toolCode",
      "typeVersion": 1,
      "position": [460, 520]
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "OpenAI Conversational Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-06T00:00:00.000Z",
  "versionId": "1"
}
